<main class="shrink grow bg-gray-50 dark:bg-dark transition-colors duration-300">
  <div class="mx-auto w-full max-w-full space-y-6 px-4 py-6 sm:px-6 lg:px-8">
    {% if paymentsList %}
      <section class="dash_card space-y-4 bg-white dark:bg-dark-card rounded-xl shadow-md dark:shadow-xl border border-gray-200 dark:border-dark-tertiary p-6 transition-all duration-300 hover:shadow-lg dark:hover:shadow-2xl">
        <div class="w-full">
          <div class="alert alert-warning mb-0 rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-amber-800 dark:text-amber-200 px-4 py-3" role="alert">
            If your card was declined, please contact your bank to approve the transaction or try using a different card.
          </div>
        </div>
        <div aria-label="Available funding methods" class="fund-logos flex flex-wrap gap-2 overflow-x-auto pb-2 mt-4 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-dark-tertiary scrollbar-track-transparent" tabindex="0">
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="gcash" type="button">
            <img alt="GCash" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/ud13o85xwton54me.png"/>
            <span class="sr-only">GCash</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="usdt" type="button">
            <img alt="USDT" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/fep4m2res7wxxt5m.png"/>
            <span class="sr-only">USDT</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="WeChat" type="button">
            <img alt="WeChat" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/7kogzy7qf0kndn55.png"/>
            <span class="sr-only">WeChat Pay</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="alipay" type="button">
            <img alt="Alipay" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/zh0t9ll4h2spn94i.png"/>
            <span class="sr-only">Alipay</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Apple Pay / Google Pay ‚Äì All Bank Cards" type="button">
            <img alt="Apple Pay and Google Pay" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/c59zig7i1fytr8jg.png"/>
            <span class="sr-only">Apple Pay / Google Pay</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Apple Pay / Google Pay ‚Äì All Bank Cards" type="button">
            <img alt="Apple Pay and Google Pay" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/p95ld0u7txc9n0r8.png"/>
            <span class="sr-only">Google Pay / Google Pay</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Cardinity ‚Äì Visa / Mastercard" type="button">
            <img alt="Cardinity" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/ue18sh7e0bnj4yml.png"/>
            <span class="sr-only">Mastercard</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Visa card" type="button">
            <img alt="Cardinity" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/1o5bscj7fqditr5o.png"/>
            <span class="sr-only">Visa</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Binance Pay" type="button">
            <img alt="Binance" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/ir12n1aczxj79ljq.png"/>
            <span class="sr-only">Binance</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="payeer" type="button">
            <img alt="Payeer" class="fund-logo__image w-10 h-10 object-contain" src="https://storage.perfectcdn.com/7gc9nb/66sdd2uuy6f1dn1t.png"/>
            <span class="sr-only">Payeer</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Nigeria (NGN) - Card / Bank Transfer " type="button">
            <img alt="Nigeria payments" class="fund-logo__image w-10 h-10 object-contain" src="https://kapowaz.github.io/square-flags/flags/ng.svg"/>
            <span class="sr-only">Nigeria (NGN) - Card / Bank Transfer</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Ghana (GHS) - Mobile Money" type="button">
            <img alt="Ghana Mobile Money" class="fund-logo__image w-10 h-10 object-contain" src="https://kapowaz.github.io/square-flags/flags/gh.svg"/>
            <span class="sr-only">Ghana (GHS) - Mobile Money</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Kenya (KES) - Mobile Money" type="button">
            <img alt="Kenya Mobile Money" class="fund-logo__image w-10 h-10 object-contain" src="https://kapowaz.github.io/square-flags/flags/ke.svg"/>
            <span class="sr-only">Kenya (KES) - Mobile Money</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Cameroon (XAF) - Mobile Money" type="button">
            <img alt="Cameroon Mobile Money" class="fund-logo__image w-10 h-10 object-contain" src="https://kapowaz.github.io/square-flags/flags/cm.svg"/>
            <span class="sr-only">Cameroon (XAF) - Mobile Money</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="C√¥te d'Ivoire (XOF) ‚Äì Mobile Money" type="button">
            <img alt="C√É¬¥te d√¢‚Ç¨‚Ñ¢Ivoire Mobile Money" class="fund-logo__image w-10 h-10 object-contain" src="https://kapowaz.github.io/square-flags/flags/ci.svg"/>
            <span class="sr-only">C√¥te d'Ivoire (XOF) ‚Äì Mobile Money</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="PhonePe - Indian Users" type="button">
            <img alt="PhonePe" class="fund-logo__image w-10 h-10 object-contain" src="https://kapowaz.github.io/square-flags/flags/in.svg"/>
            <span class="sr-only">PhonePe (India)</span>
          </button>
          <button aria-pressed="false" class="fund-logo__card flex items-center justify-center p-2 rounded-lg border-2 border-gray-200 dark:border-dark-tertiary bg-white dark:bg-dark-card transition-all duration-300 hover:border-primary-500 dark:hover:border-primary-500 hover:shadow-md hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark flex-shrink-0" data-payment-method="Expay Brasil ( Pix )" type="button">
            <img alt="Expay Brasil" class="fund-logo__image w-10 h-10 object-contain" src="https://kapowaz.github.io/square-flags/flags/br.svg"/>
            <span class="sr-only">Expay Brasil (Pix)</span>
          </button>
        </div>
      </section>
    {% endif %}

    <div class="grid gap-6 lg:grid-cols-[minmax(0,3fr)_minmax(0,2fr)]">
      <section class="dash_card tabs__wrapper space-y-8 bg-white dark:bg-dark-card rounded-xl shadow-md dark:shadow-xl border border-gray-200 dark:border-dark-tertiary p-6 transition-all duration-300">
        <div class="tabs flex gap-2 border-b border-gray-200 dark:border-dark-tertiary" role="tablist">
          <a aria-controls="addfunds" aria-selected="true" class="tab active flex items-center gap-2 px-4 py-3 font-semibold text-sm rounded-t-lg transition-all duration-300 bg-gradient-to-r from-primary-500 to-primary-600 text-white shadow-md" data-tab="addfunds" href="#addfunds" role="tab">
            <svg fill="none" height="20" viewbox="0 0 26 26" width="20" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
              <path d="M3.51332 16.1576L7.76537 11.9055L11.3009 15.4411L15.247 11.495L13.0059 9.25391H19.2559V15.5039L17.0148 13.2628L11.3009 18.9766L7.76537 15.4411L4.67268 18.5338C6.46423 21.2281 9.52767 23.0039 13.0059 23.0039C18.5288 23.0039 23.0059 18.5268 23.0059 13.0039C23.0059 7.48106 18.5288 3.00391 13.0059 3.00391C7.48301 3.00391 3.00586 7.48106 3.00586 13.0039C3.00586 14.1059 3.1841 15.1661 3.51332 16.1576ZM1.59086 18.1054L1.5782 18.0928L1.58303 18.0879C0.89071 16.5346 0.505859 14.8143 0.505859 13.0039C0.505859 6.10034 6.10231 0.503906 13.0059 0.503906C19.9094 0.503906 25.5059 6.10034 25.5059 13.0039C25.5059 19.9075 19.9094 25.5039 13.0059 25.5039C7.91943 25.5039 3.54258 22.4659 1.59086 18.1054Z" fill="currentColor"/>
            </svg>
            <span>Add Funds</span>
          </a>
          <a aria-controls="paymenthistory" aria-selected="false" class="tab flex items-center gap-2 px-4 py-3 font-semibold text-sm rounded-t-lg transition-all duration-300 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-tertiary" data-tab="paymenthistory" href="#paymenthistory" role="tab">
            <svg fill="none" height="20" viewbox="0 0 26 26" width="20" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
              <path d="M8.25 3L4.5 0.5L0.75 3V21.75C0.75 23.8211 2.42894 25.5 4.5 25.5H22C24.0711 25.5 25.75 23.8211 25.75 21.75V18H23.25V3L19.5 0.5L15.75 3L12 0.5L8.25 3ZM20.75 18H5.75V21.75C5.75 22.4404 5.19035 23 4.5 23C3.80965 23 3.25 22.4404 3.25 21.75V4.33796L4.5 3.50462L8.25 6.00462L12 3.50462L15.75 6.00462L19.5 3.50462L20.75 4.33796V18ZM22 23H8.03661C8.17481 22.609 8.25 22.1882 8.25 21.75V20.5H23.25V21.75C23.25 22.4404 22.6904 23 22 23Z" fill="currentColor"/>
            </svg>
            <span>Payment History</span>
          </a>
        </div>

        <section class="tab__content-wrapper">
          <div class="active" data-tab-content="addfunds" id="addfunds" role="tabpanel">
            {% if success %}
                <div class="alert alert-dismissible alert-success rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 px-4 py-3 mb-4 {% if site['rtl'] %} rtl-alert {% endif %}">
                    <button type="button" class="close float-right text-green-800 dark:text-green-200 hover:text-green-900 dark:hover:text-green-100 font-bold text-xl leading-none" data-dismiss="alert" aria-label="Close">&times;</button>
                    {{ successText }}
                </div>
            {% endif %}
            {% if error %}
                <div class="alert alert-dismissible alert-danger rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-200 px-4 py-3 mb-4 {% if site['rtl'] %} rtl-alert {% endif %}">
                    <button type="button" class="close float-right text-red-800 dark:text-red-200 hover:text-red-900 dark:hover:text-red-100 font-bold text-xl leading-none" data-dismiss="alert" aria-label="Close">&times;</button>
                    {{ errorText }}
                </div>
            {% endif %}
            <form {% if site['rtl'] %} class="rtl-form" {% endif %} method="post" action="" id="payment-form">
              <div class="form-group mb-4">
                <label for="method" class="control-label block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">{{ lang('addfunds.method') }}</label>
                {% set firstPayment = paymentsList|first %}
                {% set selectedPaymentName = '' %}
                <div class="custom-select" id="method-dropdown">
                  <select class="custom-select__native" id="method" name="AddFoundsForm[type]">
                    {% for payment in paymentsList %}
                      {% set isSelected = currentPayment == payment['id'] %}
                      {% set paymentMeta = payment|json_encode|escape('html_attr') %}
                      <option value="{{ payment['id'] }}" data-meta="{{ paymentMeta }}"{% if isSelected %} selected{% endif %}>{{ payment['name'] }}</option>
                      {% if isSelected %}
                        {% set selectedPaymentName = payment['name'] %}
                      {% endif %}
                    {% endfor %}
                  </select>
                  <div class="custom-select__button form-control" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
                    <span class="custom-select__label-group">
                      <span class="custom-select__option-avatar" data-role="selected-icon" aria-hidden="true" hidden></span>
                      <span class="custom-select__label" data-role="selected-label">{{ selectedPaymentName|default(firstPayment['name']) }}</span>
                    </span>
                    <span class="custom-select__chevron"></span>
                  </div>
                  <div class="custom-select__list custom-options" role="listbox" tabindex="-1">
                    {% for payment in paymentsList %}
                      {% set isSelected = currentPayment == payment['id'] %}
                      {% set paymentMeta = payment|json_encode|escape('html_attr') %}
                      <div class="custom-select__option custom-option" data-value="{{ payment['id'] }}" data-meta="{{ paymentMeta }}" aria-selected="{{ isSelected ? 'true' : 'false' }}" role="option">
                        <div class="custom-select__option-content">
                          <span class="custom-select__option-avatar" data-role="option-icon" aria-hidden="true" hidden></span>
                          <div class="custom-select__option-text">
                            <span class="custom-select__option-title" data-role="option-label">{{ payment['name'] }}</span>
                          </div>
                        </div>
                        <span class="custom-select__option-check" aria-hidden="true">
                          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6.40094 10.9359L3.99713 8.53207L5.05778 7.47141L6.40094 8.81457L10.3902 4.82532L11.4509 5.88598L6.40094 10.9359Z" fill="currentColor"/>
                          </svg>
                        </span>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>


              <div class="form-group mb-4" data-label="{{ lang('addfunds.amount') }}" id="amount-group">
                <label for="amount" class="control-label block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">{{ lang('addfunds.amount') }}</label>
                <input type="number" class="form-control w-full px-4 py-3 border border-gray-300 dark:border-dark-tertiary rounded-lg bg-white dark:bg-dark-card text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200" name="AddFoundsForm[amount]" id="amount" inputmode="decimal" min="0" step="0.01" autocomplete="off" placeholder="0.00">
              </div>

              <div class="form-group mb-4" id="after-bonus-group">
                <label class="control-label block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2" for="after-bonus-display">{{ afterBonusLabel }}</label>
                <div class="flex items-center gap-3 rounded-xl border-2 border-purple-200 dark:border-purple-800 bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 px-4 py-4 shadow-sm transition-all duration-300 hover:shadow-md" id="after-bonus-display">
                  <span aria-hidden="true" class="flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900/40 dark:to-pink-900/40 text-2xl shadow-sm">üéÅ</span>
                  <div class="flex flex-col">
                    <span class="text-xl font-bold text-purple-900 dark:text-purple-200" data-role="after-bonus-total">0.00</span>
                    <span class="text-xs text-purple-700 dark:text-purple-300" data-role="after-bonus-note" data-default-text="{{ afterBonusNoteText }}" data-empty-text="{{ afterBonusEmptyText }}">{{ afterBonusNoteText }}</span>
                  </div>
                </div>
              </div>

              {% if site['cpf_field'] %}
                <div class="form-group mb-4">
                  <label for="cpf" class="control-label block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">{{ lang('addfunds.cpf') }}</label>
                  <input type="text" class="form-control w-full px-4 py-3 border border-gray-300 dark:border-dark-tertiary rounded-lg bg-white dark:bg-dark-card text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200" name="AddFoundsForm[cpf]" id="cpf">
                </div>
              {% endif %}

              <input type="hidden" name="_csrf" value="{{ csrftoken }}">
              <button type="submit" class="btn btn--primary mt-4 w-full px-6 py-3 text-center font-semibold text-white rounded-lg bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98]" id="submit_b">Pay</button>
            </form>
          </div>

          <div data-tab-content="paymenthistory" id="paymenthistory" role="tabpanel" class="hidden">
            {% if paymentList %}
              <div class="overflow-x-auto">
                <table aria-label="{{ lang('addfunds.payment_history')|default('Payment history') }}" class="payments-table w-full" id="payment-history-table">
                  <thead class="bg-gray-50 dark:bg-dark-tertiary">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">ID</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">{{ lang('addfunds.date') }}</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">{{ lang('addfunds.method') }}</th>
                      <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Amount</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200 dark:divide-dark-tertiary">
                    {% for payment in paymentList %}
                      <tr class="payment-row hover:bg-gray-50 dark:hover:bg-dark-tertiary transition-colors duration-150">
                        <th class="payment-row__id px-4 py-4 whitespace-nowrap" scope="row">
                          <div class="pyt-id text-sm font-semibold text-primary-600 dark:text-primary-400">#{{ payment['id'] }}</div>
                        </th>
                        <td class="payment-row__detail px-4 py-4">
                          <h3 class="pyt-title text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">{{ lang('addfunds.date') }}</h3>
                          <p class="pyt-text text-sm text-gray-900 dark:text-gray-100">{{ payment['date'] }}</p>
                        </td>
                        <td class="payment-row__detail px-4 py-4">
                          <h3 class="pyt-title text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">{{ lang('addfunds.method') }}</h3>
                          <p class="pyt-text text-sm text-gray-900 dark:text-gray-100">{{ payment['method'] }}</p>
                        </td>
                        <td class="payment-row__amount px-4 py-4 whitespace-nowrap text-right">
                          <div class="pyt-amount text-sm font-bold text-gray-900 dark:text-gray-100">
                            {% if payment['original_amount'] %}
                              <span class="pyt-amount__converted" data-placement="left" data-toggle="tooltip" title="{{ payment['original_amount'] }}&nbsp;{{ payment['original_currency'] }}">‚âà {{ payment['amount'] }}</span>
                            {% else %}
                              {{ payment['amount'] }}
                            {% endif %}
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% if pagination['count'] > 50 %}
                <div class="pagination flex items-center justify-center gap-2 mt-6">
                  {% if pagination['current'] != 1 %}
                    <a aria-label="Previous" class="carousel-prev flex h-10 w-10 items-center justify-center rounded-lg border border-primary-500 dark:border-primary-400 text-primary-500 dark:text-primary-400 hover:bg-primary-500 hover:text-white dark:hover:bg-primary-600 transition-all duration-200" href="{{ page['url'] }}/{{ pagination['last'] }}">
                      <svg fill="none" height="20" viewbox="0 0 12 20" width="12" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10.3281 1.33398L1.66146 10.0007L10.3281 18.6673" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                      </svg>
                    </a>
                  {% endif %}

                  {% set r, l = 3, 3 %}
                  {% if pagination['current'] == 1 %}
                    {% set r = 6 %}
                  {% endif %}
                  {% if pagination['current'] == 2 %}
                    {% set r = 5 %}
                  {% endif %}
                  {% if pagination['current'] >= pagination['pages'] %}
                    {% set l = 5 %}
                  {% endif %}

                  {% for i in 1..ceil(pagination['pages']) %}
                    {% if i >= (pagination['current']-l) and i <= (pagination['current']+r) %}
                      <a class="page_num flex h-10 w-10 items-center justify-center rounded-lg border border-gray-300 dark:border-dark-tertiary text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-tertiary transition-all duration-200 {% if i == pagination['current'] %} active bg-gradient-to-r from-primary-500 to-primary-600 text-white border-primary-500 shadow-md{% endif %}" href="{{ page['url'] }}/{{i}} {% if i != 1 %}?page={{ i }}{% endif %}">{{ i }}</a>
                    {% endif %}
                  {% endfor %}

                  {% if pagination['current'] < pagination['pages'] %}
                    <a aria-label="Next" class="carousel-next flex h-10 w-10 items-center justify-center rounded-lg border border-primary-500 dark:border-primary-400 text-primary-500 dark:text-primary-400 hover:bg-primary-500 hover:text-white dark:hover:bg-primary-600 transition-all duration-200" href="{{ page['url'] }}/{{ pagination['next'] }}">
                      <svg fill="none" height="20" viewbox="0 0 12 20" width="12" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1.67188 18.666L10.3385 9.99935L1.67188 1.33268" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                      </svg>
                    </a>
                  {% endif %}
                </div>
              {% endif %}
            {% else %}
              <div class="text-center py-12">
                <p class="text-gray-500 dark:text-gray-400 text-sm">No payment history available</p>
              </div>
            {% endif %}
          </div>
        </section>
      </section>

      <section class="dash_card space-y-6 bg-white dark:bg-dark-card rounded-xl shadow-md dark:shadow-xl border border-gray-200 dark:border-dark-tertiary p-6 transition-all duration-300">
        <header class="space-y-2">
          <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">How to add funds</h2>
          <p class="text-sm text-gray-600 dark:text-gray-400">Select a payment option to see the step-by-step instructions.</p>
        </header>
        <div class="tabs payment-methods flex flex-wrap gap-2" role="tablist">
          <button class="tab payment-method-tab active flex items-center gap-2 px-3 py-2 rounded-lg border-2 border-primary-500 bg-gradient-to-r from-primary-500 to-primary-600 text-white font-medium text-xs transition-all duration-200 hover:shadow-md" data-tab="applepay" role="tab" type="button">
            <img alt="Apple Pay" class="h-5 w-5 object-contain" src="https://storage.perfectcdn.com/7gc9nb/gqqulb60qsi9jl94.jpg"/>
            <span>Apple Pay / Google Pay</span>
          </button>
          <button class="tab payment-method-tab flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 dark:border-dark-tertiary bg-white dark:bg-dark-card text-gray-700 dark:text-gray-300 font-medium text-xs transition-all duration-200 hover:border-primary-500 dark:hover:border-primary-500 hover:bg-gray-50 dark:hover:bg-dark-tertiary" data-tab="gcash" role="tab" type="button">
            <img alt="GCash" class="h-5 w-5 object-contain" src="https://storage.perfectcdn.com/7gc9nb/6b0j97bu6az6gyo2.png"/>
            <span>GCash</span>
          </button>
          <button class="tab payment-method-tab flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 dark:border-dark-tertiary bg-white dark:bg-dark-card text-gray-700 dark:text-gray-300 font-medium text-xs transition-all duration-200 hover:border-primary-500 dark:hover:border-primary-500 hover:bg-gray-50 dark:hover:bg-dark-tertiary" data-tab="usdt" role="tab" type="button">
            <img alt="USDT" class="h-5 w-5 object-contain" src="https://storage.perfectcdn.com/7gc9nb/sn32hu8ioqze0aby.png"/>
            <span>USDC / USDT</span>
          </button>
          <button class="tab payment-method-tab flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 dark:border-dark-tertiary bg-white dark:bg-dark-card text-gray-700 dark:text-gray-300 font-medium text-xs transition-all duration-200 hover:border-primary-500 dark:hover:border-primary-500 hover:bg-gray-50 dark:hover:bg-dark-tertiary" data-tab="banktransfer" role="tab" type="button">
            <img alt="Bank transfer" class="h-5 w-5 object-contain" src="https://storage.perfectcdn.com/7gc9nb/slnuo31j8fkq9ag2.png"/>
            <span>Bank Transfer</span>
          </button>
          <button class="tab payment-method-tab flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 dark:border-dark-tertiary bg-white dark:bg-dark-card text-gray-700 dark:text-gray-300 font-medium text-xs transition-all duration-200 hover:border-primary-500 dark:hover:border-primary-500 hover:bg-gray-50 dark:hover:bg-dark-tertiary" data-tab="wechat" role="tab" type="button">
            <img alt="WeChat" class="h-5 w-5 object-contain" src="https://storage.perfectcdn.com/7gc9nb/65wswnjr0a1mnu84.png"/>
            <span>WeChat</span>
          </button>
          <button class="tab payment-method-tab flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 dark:border-dark-tertiary bg-white dark:bg-dark-card text-gray-700 dark:text-gray-300 font-medium text-xs transition-all duration-200 hover:border-primary-500 dark:hover:border-primary-500 hover:bg-gray-50 dark:hover:bg-dark-tertiary" data-tab="alipay" role="tab" type="button">
            <img alt="Alipay" class="h-5 w-5 object-contain" src="https://storage.perfectcdn.com/7gc9nb/z4mwcy4p38jmakj9.webp"/>
            <span>Alipay</span>
          </button>
        </div>
        <div class="info-block rounded-xl border border-primary-200 dark:border-primary-800 bg-gradient-to-br from-primary-50 to-cyan-50 dark:from-primary-900/20 dark:to-cyan-900/20 p-6 text-sm leading-7 text-gray-700 dark:text-gray-300 shadow-sm">
          <div class="space-y-3" data-tab-content="applepay">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Apple Pay / Google Pay</h3>
            <p class="font-semibold text-gray-600 dark:text-gray-400">Fill your balance using Apple Pay, Google Pay, or any supported card.</p>
            <ul class="mt-4 space-y-2">
              <li>‚úÖ Select "Credit Card | Debit Card: Apple Pay - Google Pay - Visa - Mastercard - Amex".</li>
              <li>‚úÖ Enter the amount you want to add and confirm the payment.</li>
              <li>‚úÖ Pay with Apple Pay, Google Pay, or your debit/credit card.</li>
              <li>‚úÖ Funds are added automatically once the transaction is complete.</li>
            </ul>
          </div>
          <div class="space-y-3 hidden" data-tab-content="usdt">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Crypto currencies</h3>
            <p class="font-semibold text-gray-600 dark:text-gray-400">Add balance with USDT, USDC, BUSD, and other supported coins.</p>
            <ul class="mt-4 space-y-2">
              <li>‚úÖ We accept direct transfers of USDT, USDC, BUSD, and most major coins.</li>
              <li>‚úÖ Open a support ticket if you need to pay with a specific coin.</li>
              <li>‚úÖ Enjoy a 5% bonus on every crypto deposit above $10.</li>
            </ul>
          </div>
          <div class="space-y-3 hidden" data-tab-content="gcash">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">GCash</h3>
            <p class="font-semibold text-gray-600 dark:text-gray-400">Top up quickly with GCash payments.</p>
            <ul class="mt-4 space-y-2">
              <li>‚úÖ Send your payment to GCash number <strong>0905-298-2655</strong>.</li>
              <li>‚úÖ Open a ticket with the transaction ID once the transfer is complete.</li>
              <li>‚úÖ We will credit the funds to your balance promptly.</li>
              <li>‚úÖ Need help? Message us on Telegram at <strong>@marketerum</strong> for GCash deposits.</li>
            </ul>
          </div>
          <div class="space-y-3 hidden" data-tab-content="banktransfer">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Bank transfer</h3>
            <p class="font-semibold text-gray-600 dark:text-gray-400">Use regional bank transfers to add balance.</p>
            <ul class="mt-4 space-y-2">
              <li>‚úÖ We accept transfers from China, the Philippines, and Thailand.</li>
              <li>‚úÖ European transfers must come from business bank accounts.</li>
              <li>‚úÖ Request our bank details via ticket or through our social channels.</li>
              <li>‚úÖ Funds are credited manually once the payment is confirmed.</li>
            </ul>
          </div>
          <div class="space-y-3 hidden" data-tab-content="wechat">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">WeChat</h3>
            <p class="font-semibold text-gray-600 dark:text-gray-400">Recharge via WeChat Pay.</p>
            <ul class="mt-4 space-y-2">
              <li>‚úÖ Open a ticket to request our WeChat Pay number or QR code.</li>
              <li>‚úÖ ‰∏≠ÂõΩÁî®Êà∑Â¶ÇÈúÄ‰ΩøÁî®ÂæÆ‰ø°ÊîØ‰ªòÔºåËØ∑Êèê‰∫§Â∑•ÂçïÔºåÊàë‰ª¨‰ºöÊèê‰æõÂæÆ‰ø°ÊîØ‰ªòË¥¶Âè∑Êàñ‰∫åÁª¥Á†Å„ÄÇ</li>
            </ul>
          </div>
          <div class="space-y-3 hidden" data-tab-content="alipay">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100">Alipay</h3>
            <p class="font-semibold text-gray-600 dark:text-gray-400">Use Alipay for fast deposits.</p>
            <ul class="mt-4 space-y-2">
              <li>‚úÖ Contact support to receive our Alipay details or QR code before paying.</li>
              <li>‚úÖ ‰∏≠ÂõΩÁî®Êà∑ËØ∑Êèê‰∫§Â∑•ÂçïËé∑ÂèñÊîØ‰ªòÂÆùË¥¶Âè∑Êàñ‰∫åÁª¥Á†ÅÔºå‰ª•‰æøÂÆåÊàêÂÖÖÂÄº„ÄÇ</li>
            </ul>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
<script>
  (function(){
    const DISALLOWED_CONTAINERS = new Set(['SCRIPT','STYLE','TEXTAREA','CODE','PRE','NOSCRIPT','OPTION']);
    const FLAG_SEQUENCE_REGEX = (() => {
      try {
        return new RegExp('(?:\\p{Regional_Indicator}){2}', 'gu');
      } catch (_) {
        return /(?:\uD83C[\uDDE6-\uDDFF]){2}/g;
      }
    })();

    function toCodePoint(flag){
      if (window.twemoji && window.twemoji.convert && typeof window.twemoji.convert.toCodePoint === 'function') {
        try { return window.twemoji.convert.toCodePoint(flag); }
        catch (_) {}
      }
      return Array.from(flag).map(ch => ch.codePointAt(0).toString(16)).join('-');
    }

    function createFlagImage(flag){
      const img = document.createElement('img');
      img.alt = flag;
      img.loading = 'lazy';
      img.decoding = 'async';
      img.setAttribute('aria-hidden','false');
      img.className = 'emoji emoji-flag';
      img.style.height = '1em';
      img.style.verticalAlign = '-0.15em';
      img.style.display = '';
      img.style.visibility = 'visible';
      const codePoint = toCodePoint(flag);
      img.src = `https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/svg/${codePoint}.svg`;
      return img;
    }

    function replaceFlagEmojis(root = document.body){
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
      const candidates = [];
      let node;
      while ((node = walker.nextNode())) {
        if (!node.nodeValue || !node.nodeValue.trim()) continue;
        const parent = node.parentNode;
        if (!parent || DISALLOWED_CONTAINERS.has(parent.nodeName)) continue;
        if (parent.classList && (parent.classList.contains('emoji') || parent.classList.contains('twemoji'))) continue;
        if (!FLAG_SEQUENCE_REGEX.test(node.nodeValue)) continue;
        FLAG_SEQUENCE_REGEX.lastIndex = 0;
        candidates.push(node);
      }

      for (const textNode of candidates){
        const text = textNode.nodeValue;
        FLAG_SEQUENCE_REGEX.lastIndex = 0;
        let match;
        let lastIndex = 0;
        const frag = document.createDocumentFragment();
        while ((match = FLAG_SEQUENCE_REGEX.exec(text))){
          const flag = match[0];
          if (match.index > lastIndex){
            frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
          }
          frag.appendChild(createFlagImage(flag));
          lastIndex = match.index + flag.length;
        }
        if (!frag.childNodes.length) continue;
        if (lastIndex < text.length){
          frag.appendChild(document.createTextNode(text.slice(lastIndex)));
        }
        const parent = textNode.parentNode;
        if (!parent) continue;
        parent.replaceChild(frag, textNode);
      }
    }

    document.addEventListener('DOMContentLoaded', () => replaceFlagEmojis());
  })();
</script>
<script>
(function () {
  /* ===========================
   *  Twemoji helpers
   * =========================== */
  const TWEMOJI_OPTIONS = {
    folder: 'svg',
    ext: '.svg',
    attributes: () => ({
      class: 'emoji twemoji',
      loading: 'lazy',
      decoding: 'async',
      draggable: 'false',
      role: 'img'
    })
  };

  const REGIONAL_INDICATOR_BASE = 'A'.charCodeAt(0);
  const REGIONAL_INDICATOR_START = 0x1f1e6;

  function normalizeEmojiValue(raw) {
    if (raw === null || raw === undefined) return '';
    let value = `${raw}`.trim();
    if (!value) return '';

    if (/^[A-Za-z]{2}$/.test(value)) {
      const upper = value.toUpperCase();
      const first = upper.charCodeAt(0);
      const second = upper.charCodeAt(1);
      const limit = REGIONAL_INDICATOR_BASE + 25;
      if (
        first >= REGIONAL_INDICATOR_BASE &&
        first <= limit &&
        second >= REGIONAL_INDICATOR_BASE &&
        second <= limit
      ) {
        value = String.fromCodePoint(
          REGIONAL_INDICATOR_START + (first - REGIONAL_INDICATOR_BASE),
          REGIONAL_INDICATOR_START + (second - REGIONAL_INDICATOR_BASE)
        );
      }
    }

    return value;
  }

  function renderEmoji(target, emoji) {
    if (!target || !emoji) return;
    const value = normalizeEmojiValue(emoji);
    if (!value) return;

    target.innerHTML = '';
    target.classList.remove('is-image');
    target.classList.add('is-emoji');
    target.hidden = false;
    target.removeAttribute('hidden');
    target.style.display = '';
    target.style.visibility = 'visible';
    target.setAttribute('aria-hidden', 'false');

    if (window.twemoji && typeof window.twemoji.parse === 'function') {
      try {
        const parsed = window.twemoji.parse(value, TWEMOJI_OPTIONS);
        if (typeof parsed === 'string' && parsed) {
          target.innerHTML = parsed;
          return;
        }
      } catch (_) {}
    }

    target.textContent = value;
  }

  /* ===========================
   *  Utilities
   * =========================== */
  function parseJSONSafe(v){ try{ return v ? JSON.parse(v) : null; }catch(e){ return null; } }
  function parseNumeric(value){
    if (value === null || value === undefined) return null;
    if (typeof value === 'number') return Number.isFinite(value) ? value : null;
    if (typeof value !== 'string') return null;
    let t = value.trim(); if (!t) return null;
    t = t.replace(/\s+/g,'');
    const hasC = t.includes(','), hasD = t.includes('.');
    if (hasC && hasD){ if (t.lastIndexOf('.') > t.lastIndexOf(',')) t = t.replace(/,/g,''); else t = t.replace(/\./g,'').replace(',', '.'); }
    else if (hasC){ t = t.replace(/,/g,'.'); }
    t = t.replace(/[^0-9.-]/g,'');
    const n = parseFloat(t);
    return Number.isFinite(n) ? n : null;
  }
  function findFirstString(obj, keys){
    if (!obj || typeof obj !== 'object') return '';
    const seen = new Set(), stack=[obj];
    while (stack.length){
      const cur = stack.pop(); if (!cur || typeof cur !== 'object' || seen.has(cur)) continue; seen.add(cur);
      if (Array.isArray(cur)){ cur.forEach(v=>stack.push(v)); continue; }
      for (const k of keys){ if (Object.prototype.hasOwnProperty.call(cur,k)){ const v=cur[k]; if (typeof v==='string' && v.trim()) return v.trim(); } }
      ['bonus','bonuses','fee','fees','metadata','meta','config','details','extra','options','data'].forEach(k=>{ if (cur[k] && typeof cur[k]==='object') stack.push(cur[k]); });
    }
    return '';
  }
  function findFirstNumber(obj, keys){
    if (!obj || typeof obj !== 'object') return null;
    const seen = new Set(), stack=[obj];
    while (stack.length){
      const cur = stack.pop(); if (!cur || typeof cur !== 'object' || seen.has(cur)) continue; seen.add(cur);
      if (Array.isArray(cur)){ cur.forEach(v=>stack.push(v)); continue; }
      for (const k of keys){ if (Object.prototype.hasOwnProperty.call(cur,k)){ const n = parseNumeric(cur[k]); if (n!==null) return n; } }
      ['bonus','bonuses','fee','fees','metadata','meta','config','details','extra','options','data'].forEach(k=>{ if (cur[k] && typeof cur[k]==='object') stack.push(cur[k]); });
    }
    return null;
  }
  function formatCurrencyValue(value, cfg){
    const amt = Number.isFinite(value) ? value : 0;
    try{ return new Intl.NumberFormat((cfg&&cfg.locale)||'en-US',{style:'currency',currency:(cfg&&cfg.currency)||'USD',minimumFractionDigits:2,maximumFractionDigits:2}).format(amt); }
    catch(e){ return amt.toFixed(2); }
  }

  /* ===========================
   *  PaymentVisuals (icons only)
   * =========================== */
  const PaymentVisuals = (() => {
    const IMAGE_KEYS = ['icon_url','iconUrl','icon','logo','logo_url','logoUrl','image','image_url','imageUrl','thumbnail','thumb','iconSrc','imageSrc','iconLight','iconDark'];
    const EMOJI_KEYS = ['emoji','iconEmoji','flag','flag_emoji','flagEmoji','country_emoji','countryEmoji'];
    const COUNTRY_CODE_KEYS = ['country_code','countryCode','country_iso','countryISO','country','region','locale'];
    const COUNTRY_KEYWORD_MAP = [
      { regex: /\bbrazil\b/i, code: 'BR' }, { regex: /\bbrasil\b/i, code: 'BR' },
      { regex: /\bindia\b/i, code: 'IN' },  { regex: /\bindian\b/i, code: 'IN' },
      { regex: /\bnigeria\b/i, code: 'NG' },{ regex: /\bghana\b/i, code: 'GH' },
      { regex: /\bkenya\b/i, code: 'KE' },  { regex: /\bcameroon\b/i, code: 'CM' },
      { regex: /\bc(?:o|√¥|√É¬¥)te\s*d['‚Äô`]?ivoire\b/i, code: 'CI' }, { regex: /\bivory\s+coast\b/i, code: 'CI' },
      { regex: /\bunited\s*arab\s*emirates\b/i, code: 'AE' }, { regex: /\buae\b/i, code: 'AE' },
      { regex: /\bphilippines\b/i, code: 'PH' }, { regex: /\bgcash\b/i, code: 'PH' },
      { regex: /\bchina\b/i, code: 'CN' }, { regex: /\bwechat\b/i, code: 'CN' }, { regex: /\bwe\s*chat\b/i, code: 'CN' },
      { regex: /\balipay\b/i, code: 'CN' }, { regex: /ÊîØ‰ªòÂØ∂|ÊîØ‰ªòÂÆù|ÂæÆ‰ø°ÊîØ‰ªò|ÂæÆ‰ø°/, code: 'CN' },
      { regex: /\beuropean\s*union\b/i, code: 'EU' },
    ];
    const CURRENCY_FLAG_MAP = {
      AED:'AE', BRL:'BR', BR:'BR', CNY:'CN', EUR:'EU', EU:'EU', GHS:'GH',
      INR:'IN', KES:'KE', NGN:'NG', PHP:'PH', RMB:'CN', XAF:'CM', XOF:'CI'
    };

    let LEADING_EMOJI_REGEX;
    try {
      LEADING_EMOJI_REGEX = new RegExp(
        '^((?:\\p{Extended_Pictographic}(?:\\uFE0F|\\u200D\\p{Extended_Pictographic})*)|(?:\\p{Regional_Indicator}{2}))','u'
      );
    } catch {
      LEADING_EMOJI_REGEX = /^((?:\uD83C[\uDDE6-\uDDFF]){2}|(?:[\uD83C-\uDBFF][\uDC00-\uDFFF]|[\u2600-\u27BF])(?:\uFE0F|\uD83C[\uDFFB-\uDFFF])?(?:\u200D(?:[\uD83C-\uDBFF][\uDC00-\uDFFF]))*)/;
    }

    function parsePotentialImg(v){
      if (!v || typeof v!=='string') return '';
      let t=v.trim(); if(!t) return '';
      const m=t.match(/<img[^>]*src\s*=\s*["']([^"']+)["'][^>]*>/i);
      if (m && m[1]) t=m[1].trim();
      t=t.replace(/&amp;/g,'&');
      if (/^data:image\//i.test(t)) return t;
      if (/^(https?:)?\/\//i.test(t)) return t;
      if (t.startsWith('/')) return t;
      return '';
    }
    function deepFindString(obj, keys){
      if (!obj || typeof obj!=='object') return '';
      const seen=new Set(), stack=[obj];
      while (stack.length){
        const cur=stack.pop(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
        if (Array.isArray(cur)){ cur.forEach(v=>stack.push(v)); continue; }
        for (const k of keys){ if (Object.prototype.hasOwnProperty.call(cur,k)){ const val=cur[k]; if (typeof val==='string' && val.trim()) return val.trim(); if (val && typeof val==='object') stack.push(val); } }
        Object.values(cur).forEach(v=>{ if(v&&typeof v==='object'&&!seen.has(v)) stack.push(v); });
      }
      return '';
    }
    function toFlagEmoji(code){
      if (!code || typeof code!=='string') return '';
      let cand = code.trim().replace(/[^A-Za-z]/g,'').toUpperCase();
      if (!cand) return '';
      if (cand.length===2){
        const start=0x1f1e6, A=65;
        const a=cand.charCodeAt(0), b=cand.charCodeAt(1);
        if (a>=A&&a<=90&&b>=A&&b<=90) return String.fromCodePoint(start+a-A, start+b-A);
        return '';
      }
      if (CURRENCY_FLAG_MAP[cand]) return toFlagEmoji(CURRENCY_FLAG_MAP[cand]);
      return '';
    }
    function deriveFlagFromLabel(label){
      if (!label) return '';
      const n = label.toLowerCase();
      for (const e of COUNTRY_KEYWORD_MAP){ if (e.regex.test(n)) return toFlagEmoji(e.code); }
      const curr = n.match(/\b([A-Z]{3})\b/);
      if (curr && curr[1]){ const f = toFlagEmoji(curr[1]); if (f) return f; }
      return '';
    }
    function extractLeadingEmojiSegment(text){
      if (!text) return { emoji:'', rest:'', normalized:'' };
      const normalized = String(text).replace(/\u00a0/g,' ');
      const trimmed = normalized.replace(/^\s+/,'');
      let emoji='', rest=trimmed;
      try {
        const m = trimmed.match(LEADING_EMOJI_REGEX);
        if (m && m[0]){ emoji=m[0]; rest = trimmed.slice(m[0].length).replace(/^\s+/, ''); }
      } catch {}
      return { emoji, rest, normalized: normalized.trim() };
    }
    function deriveDisplay(meta, labelText){
      const base = typeof labelText==='string' ? labelText : '';
      const cleaned = base.replace(/\u00a0/g,' ');
      const { emoji:leadingEmoji, rest:labelWithoutEmoji, normalized } = extractLeadingEmojiSegment(cleaned);
      const img = parsePotentialImg(deepFindString(meta, IMAGE_KEYS));
      let iconType='', iconValue='';
      if (img){ iconType='image'; iconValue=img; }
      else {
        let emojiCandidate = deepFindString(meta, EMOJI_KEYS);
        if (!emojiCandidate){
          const flag = toFlagEmoji(deepFindString(meta, COUNTRY_CODE_KEYS));
          if (flag) emojiCandidate = flag;
        }
        if (!emojiCandidate){
          const derived = deriveFlagFromLabel(cleaned);
          if (derived) emojiCandidate = derived;
        }
        if (!emojiCandidate && leadingEmoji){ emojiCandidate = leadingEmoji; }
        if (emojiCandidate){
          const normalizedEmoji = normalizeEmojiValue(emojiCandidate);
          if (normalizedEmoji){
            iconType='emoji';
            iconValue=normalizedEmoji;
          }
        }
      }
      let displayLabel = normalized || cleaned.trim() || base;
      if (iconType==='emoji' && leadingEmoji && iconValue && iconValue.trim()===leadingEmoji.trim()){
        displayLabel = labelWithoutEmoji || displayLabel;
      } else if (iconType==='image' && leadingEmoji){
        displayLabel = labelWithoutEmoji || displayLabel;
      }
      displayLabel = (displayLabel||'').trim() || base.trim();
      return { iconType, iconValue, labelText: displayLabel || base || '', originalLabel: base || '' };
    }
    function renderIcon(target, display){
      if (!target) return;
      target.innerHTML=''; target.classList.remove('is-image','is-emoji'); 
      target.hidden=true; target.style.display='none';
      target.setAttribute('aria-hidden','true'); target.setAttribute('hidden','');
      if (!display || !display.iconType || !display.iconValue) return;

      if (display.iconType==='image'){
        const img=document.createElement('img');
        img.src=display.iconValue; img.alt=''; img.loading='lazy'; img.decoding='async';
        target.appendChild(img); target.classList.add('is-image');
        target.hidden=false; target.removeAttribute('hidden'); target.style.display=''; target.style.visibility='visible';
        target.setAttribute('aria-hidden','false');
      } else if (display.iconType==='emoji'){
        // ‚úÖ icon only; render with Twemoji assets when available
        renderEmoji(target, display.iconValue);
      }
    }
    function decorateOption(optionEl, meta, labelText){
      if (!optionEl) return { iconType:'', iconValue:'', labelText: labelText||'' };
      const display = deriveDisplay(meta, labelText || optionEl.textContent || '');
      const targetLabel = optionEl.querySelector('[data-role="option-label"]');
      const iconTarget  = optionEl.querySelector('[data-role="option-icon"]');

      optionEl.dataset.originalLabel = labelText || optionEl.textContent || '';
      optionEl.dataset.displayLabel  = display.labelText || optionEl.dataset.originalLabel;
      optionEl.dataset.iconType      = display.iconType || '';
      optionEl.dataset.iconValue     = display.iconValue || '';

      if (targetLabel) targetLabel.textContent = optionEl.dataset.displayLabel; else optionEl.textContent = optionEl.dataset.displayLabel;
      renderIcon(iconTarget, display);
      optionEl.setAttribute('aria-label', optionEl.dataset.displayLabel);

      return display;
    }
    function getDisplayFromOption(optionEl, fallbackLabel){
      if (!optionEl) return { iconType:'', iconValue:'', labelText: fallbackLabel||'' };
      const ds = optionEl.dataset || {};
      const label = ds.displayLabel || fallbackLabel || ds.originalLabel || '';
      return { iconType: ds.iconType || '', iconValue: ds.iconValue || '', labelText: label };
    }
    function applySelection(labelEl, iconEl, optionEl, fallbackLabel){
      const display = getDisplayFromOption(optionEl, fallbackLabel);
      renderIcon(iconEl, display); // update only icon
      if (labelEl) labelEl.textContent = display.labelText || fallbackLabel || '';
      return display;
    }
    return { decorateOption, applySelection };
  })();

  /* ===========================
   *  Add Funds bindings
   * =========================== */
  function tokenize(str){ const n=(str||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,' ').trim(); return n? n.split(/\s+/):[]; }
  function slugify(str){ return (str||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,''); }
  function overlapScore(a,b){ if(!a.length||!b.length) return 0; const set=new Set(b); let s=0; a.forEach(t=>{ if(set.has(t)) s++; }); return s; }
  function toSlugList(value){
    if (!value) return [];
    if (Array.isArray(value)) return value.filter(Boolean);
    return [value].filter(Boolean);
  }
  function getInfoSlugs(info){
    if (!info) return [];
    if (Array.isArray(info.slugVariants)) return info.slugVariants.filter(Boolean);
    if (Array.isArray(info.slug)) return info.slug.filter(Boolean);
    return info.slug ? [info.slug] : [];
  }
  function slugAffinity(candidateSlugs, targetSlugs){
    if (!candidateSlugs.length || !targetSlugs.length) return 0;
    let best = 0;
    candidateSlugs.forEach(cSlug=>{
      targetSlugs.forEach(tSlug=>{
        if (!cSlug || !tSlug) return;
        if (cSlug === tSlug) best = Math.max(best, 3);
        else if (cSlug.includes(tSlug) || tSlug.includes(cSlug)) best = Math.max(best, 2);
      });
    });
    return best;
  }
  function getMatchedInfoByTokens(sourceInfo, targetTokens, targetSlug){
    const targetSlugs = toSlugList(targetSlug);
    let best=null, bestScore=0, bestSlugScore=-Infinity;
    sourceInfo.forEach(info=>{
      if (!info) return;
      const sc = overlapScore(info.tokens||[], targetTokens||[]);
      const slugScore = slugAffinity(getInfoSlugs(info), targetSlugs);
      if (sc>bestScore || (sc===bestScore && slugScore>bestSlugScore)){
        bestScore=sc; best=info; bestSlugScore=slugScore;
      }
    });
    if (best && bestScore>0) return best;
    if (targetSlugs.length){
      let slugBest=null, slugBestScore=0;
      sourceInfo.forEach(info=>{
        const score = slugAffinity(getInfoSlugs(info), targetSlugs);
        if (score>slugBestScore){ slugBestScore=score; slugBest=info; }
      });
      if (slugBest) return slugBest;
    }
    return null;
  }
  function extractBonusHintsFromText(text){
    if (!text || typeof text!=='string') return { percent:null, threshold:null };
    const cleaned = text.replace(/&amp;/g,'&');
    const percentMatch = cleaned.match(/([0-9]+(?:[.,][0-9]+)?)\s*%/);
    const thresholdMatch = cleaned.match(/(?:from|over|above)\s*([^0-9a-zA-Z]{0,3})\s*([0-9]+(?:[.,][0-9]+)?)/i);
    return {
      percent: percentMatch ? parseNumeric(percentMatch[1]) : null,
      threshold: thresholdMatch ? parseNumeric(thresholdMatch[2]) : null,
    };
  }
  function gatherBonusHints(meta){
    const sources = [];
    const name = findFirstString(meta,['display_name','displayName','name','title','label']);
    if (name) sources.push(name);
    const description = findFirstString(meta,['description','note','tooltip','message']);
    if (description) sources.push(description);
    const extra = findFirstString(meta,['subtitle','subTitle','details','extra']);
    if (extra) sources.push(extra);
    return sources.map(extractBonusHintsFromText).reduce((acc,curr)=>{
      if (acc.percent===null && Number.isFinite(curr.percent)) acc.percent=curr.percent;
      if (acc.threshold===null && Number.isFinite(curr.threshold)) acc.threshold=curr.threshold;
      return acc;
    },{percent:null,threshold:null});
  }
  function computeAfterBonus(meta, amount){
    if (!meta || typeof meta!=='object'){
      return { total: amount, formattedTotal: formatCurrencyValue(amount,{currency:'USD',locale:'en-US'}), note:'', bonusAmount:0, feeAmount:0 };
    }
    const cfg = { currency: findFirstString(meta,['currency','currencyCode','currency_code'])||'USD',
                  locale:   findFirstString(meta,['locale','language','lang'])||'en-US' };
    const hints = gatherBonusHints(meta);
    let threshold = findFirstNumber(meta,['bonus_threshold','bonusThreshold','bonus_min','bonusMin','min_bonus','minBonus','min_bonus_amount','minimum_bonus_amount','bonus_minimum']);
    if (threshold===null && Number.isFinite(hints.threshold)) threshold = hints.threshold;
    const ok = threshold===null || amount>=threshold;
    let pRaw = ok ? findFirstNumber(meta,['bonus_percent','bonusPercentage','bonus_rate','bonusRate','bonusPercent','percent_bonus','percentage_bonus']) : null;
    if ((pRaw===null || !Number.isFinite(pRaw)) && Number.isFinite(hints.percent)) pRaw = hints.percent;
    const fRaw = ok ? findFirstNumber(meta,['bonus_fixed','bonusFixed','bonus_amount','bonusAmount','fixed_bonus','bonus_fixed_amount']) : null;
    const feePRaw = findFirstNumber(meta,['fee_percent','feePercentage','processing_percent','processingFeePercent','processing_fee_percent']);
    const feeFRaw = findFirstNumber(meta,['fee_fixed','feeFixed','processing_fee','fee_amount','processingFee']);
    const p = pRaw!==null ? (pRaw>1 ? pRaw/100 : pRaw) : 0;
    const fp= feePRaw!==null ? (feePRaw>1 ? feePRaw/100 : feePRaw) : 0;
    const bonus = Math.max(0,(p?amount*p:0)+(fRaw||0));
    const fee   = Math.max(0,(fp?amount*fp:0)+(feeFRaw||0));
    const total = Math.max(0, amount - fee + bonus);
    const parts=[]; if(bonus>0) parts.push('Bonus: '+formatCurrencyValue(bonus,cfg)); if(fee>0) parts.push('Fees: '+formatCurrencyValue(fee,cfg));
    let note = parts.join(' - ') || findFirstString(meta,['bonus_note','note','description','message','tooltip']) || '';
    return { total, formattedTotal: formatCurrencyValue(total,cfg), note, bonusAmount:bonus, feeAmount:fee };
  }

  function bindMethodDropdown(){
    const wrap   = document.getElementById('method-dropdown');
    const select = document.getElementById('method');
    if (!wrap || !select) return;
    const button       = wrap.querySelector('.custom-select__button, .form-control');
    const labelTextEl  = wrap.querySelector('[data-role="selected-label"]') || wrap.querySelector('.custom-select__label, .selected-option');
    const selectedIcon = wrap.querySelector('[data-role="selected-icon"]');
    if (selectedIcon) {
      selectedIcon.hidden = true;
      selectedIcon.style.display = 'none';
    }
    const list  = wrap.querySelector('.custom-select__list, .custom-options');
    const opts  = Array.from(list.querySelectorAll('.custom-select__option, .custom-option'));
    const nativeOptions = Array.from(select.options||[]);

    // decorate options once
    opts.forEach(optionEl=>{
      const value = optionEl.getAttribute('data-value');
      const nativeOption = nativeOptions.find(o=>o.value==value);
      const metaAttr = optionEl.getAttribute('data-meta') || nativeOption?.getAttribute('data-meta') || '';
      if (metaAttr && !optionEl.getAttribute('data-meta')) optionEl.setAttribute('data-meta', metaAttr);
      const labelNode = optionEl.querySelector('[data-role="option-label"]');
      const baseLabel = labelNode ? labelNode.textContent : (optionEl.textContent || nativeOption?.text || nativeOption?.textContent || '');
      const meta = parseJSONSafe(metaAttr);
      const display = PaymentVisuals.decorateOption(optionEl, meta, baseLabel);
      // Ensure option icon is visible on iOS if it has content
      const iconTarget = optionEl.querySelector('[data-role="option-icon"]');
      if (iconTarget && iconTarget.innerHTML.trim()) {
        iconTarget.hidden = false;
        iconTarget.removeAttribute('hidden');
        iconTarget.style.display = '';
        iconTarget.style.visibility = 'visible';
      }
      if (nativeOption && display){
        if (display.labelText){ nativeOption.text = display.labelText; nativeOption.dataset.displayLabel = display.labelText; }
        if (display.iconType){ nativeOption.dataset.iconType = display.iconType; nativeOption.dataset.iconValue = display.iconValue || ''; }
      }
    });

    const listOpts = opts;
    const form = select.closest('form');
    const submitBtn = form ? (form.querySelector('#submit_b') || form.querySelector('[type="submit"]')) : null;
    const disableSubmit = ()=>{ if(!submitBtn) return; submitBtn.dataset.disabledBySelect='1'; submitBtn.disabled=true; submitBtn.classList.add('disabled'); };
    const enableSubmit  = ()=>{ if(!submitBtn||submitBtn.dataset.disabledBySelect!=='1') return; submitBtn.disabled=false; submitBtn.classList.remove('disabled'); delete submitBtn.dataset.disabledBySelect; };

    function ensureVisible(el){
      if (!el) return;
      const r = el.getBoundingClientRect(), LR = list.getBoundingClientRect();
      if (r.top < LR.top) list.scrollTop -= (LR.top - r.top);
      else if (r.bottom > LR.bottom) list.scrollTop += (r.bottom - LR.bottom);
    }
    function highlight(el){
      listOpts.forEach(o=>o.classList.remove('is-highlighted'));
      if (el){ el.classList.add('is-highlighted'); ensureVisible(el); }
    }
    function setSelectedByValue(value, triggerChange){
      const match = Array.from(select.options).find(o=>o.value==value);
      if (!match) return;
      select.value = match.value;
      const optionItem = listOpts.find(o=>o.getAttribute('data-value')==value);
      const fallbackLabel = (match.dataset && match.dataset.displayLabel) || match.text || match.textContent || '';
      PaymentVisuals.applySelection(labelTextEl, selectedIcon, optionItem, fallbackLabel);
      // Ensure icon is visible on iOS if it has content
      if (selectedIcon && selectedIcon.innerHTML.trim()) {
        selectedIcon.hidden = false;
        selectedIcon.removeAttribute('hidden');
        selectedIcon.style.display = '';
        selectedIcon.style.visibility = 'visible';
      }
      listOpts.forEach(opt=>opt.setAttribute('aria-selected', String(opt.getAttribute('data-value')==value)));
      if (triggerChange){
        const ev=new Event('change',{bubbles:true}); select.dispatchEvent(ev);
        if (window.jQuery){ try{ window.jQuery(select).trigger('change'); }catch(e){} }
      }
    }
    function openDropdown(){ wrap.classList.add('custom-select--open'); button.setAttribute('aria-expanded','true'); list.focus(); highlight(list.querySelector('[aria-selected="true"]')||listOpts[0]); disableSubmit(); }
    function closeDropdown(cfg){ const back = !cfg || cfg.focusBack!==false; wrap.classList.remove('custom-select--open'); button.setAttribute('aria-expanded','false'); if(back) button.focus(); enableSubmit(); }
    function toggleDropdown(){ if (wrap.classList.contains('custom-select--open')) closeDropdown(); else openDropdown(); }

    button.addEventListener('click', ()=>{ toggleDropdown(); if (wrap.classList.contains('custom-select--open')) disableSubmit(); });
    button.addEventListener('mousedown', e=>e.preventDefault());
    list.addEventListener('mousedown', e=>e.preventDefault());
    list.addEventListener('click', (e)=>{
      const item = e.target.closest('.custom-select__option, .custom-option'); if(!item) return;
      setSelectedByValue(item.getAttribute('data-value'), true); closeDropdown({focusBack:true});
    });
    button.addEventListener('keydown', (e)=>{ if (['ArrowDown','Enter',' '].includes(e.key)){ e.preventDefault(); openDropdown(); } });
    list.addEventListener('keydown', (e)=>{
      const cur = list.querySelector('.custom-select__option.is-highlighted, .custom-option.is-highlighted');
      const idx = cur ? listOpts.indexOf(cur) : -1;
      if (e.key==='Escape'){ e.preventDefault(); closeDropdown({focusBack:true}); return; }
      if (e.key==='Enter'||e.key===' '){ e.preventDefault(); const t = cur || list.querySelector('[aria-selected="true"]') || listOpts[0]; if (t){ setSelectedByValue(t.getAttribute('data-value'), true); closeDropdown({focusBack:true}); } return; }
      if (e.key==='ArrowDown'){ e.preventDefault(); highlight(listOpts[Math.min((idx<0?0:idx+1), listOpts.length-1)]); }
      if (e.key==='ArrowUp'){   e.preventDefault(); highlight(listOpts[Math.max((idx<0?0:idx-1), 0)]); }
    });
    select.addEventListener('change', ()=>{ setSelectedByValue(select.value, false); });

    document.addEventListener('click', (e)=>{ if (!wrap.contains(e.target)) closeDropdown({focusBack:false}); });
    if (form){
      form.addEventListener('keydown', (e)=>{
        if ((e.key==='Enter'||e.key===' ') && wrap.classList.contains('custom-select--open') && document.activeElement && document.activeElement.closest('#method-dropdown')){
          e.preventDefault(); e.stopPropagation();
        }
      });
      form.addEventListener('submit', (e)=>{ if (wrap.classList.contains('custom-select--open')){ e.preventDefault(); e.stopPropagation(); closeDropdown({focusBack:false}); } }, true);
    }
    document.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && wrap.classList.contains('custom-select--open')){ e.preventDefault(); e.stopPropagation(); } }, true);

    const initialValue = select.value || (select.options[0] && select.options[0].value);
    if (initialValue) setSelectedByValue(initialValue, false);
    else if (listOpts[0]) {
      PaymentVisuals.applySelection(labelTextEl, selectedIcon, listOpts[0], listOpts[0].dataset.displayLabel || '');
      // Ensure icon is visible on iOS if it has content
      if (selectedIcon && selectedIcon.innerHTML.trim()) {
        selectedIcon.hidden = false;
        selectedIcon.removeAttribute('hidden');
        selectedIcon.style.display = '';
        selectedIcon.style.visibility = 'visible';
      }
    }
  }

  function wireQuickAmounts(onValueSelected, getAmountValueFn){
    const container = document.getElementById('quick-amounts');
    if (!container){ window.__wireQuickAmounts=()=>{}; return null; }
    const buttons = Array.from(container.querySelectorAll('.quick-amount-btn'));
    if (!buttons.length){ window.__wireQuickAmounts=()=>{}; return null; }
    function updateState(nextValue){
      const active = Number.isFinite(nextValue) ? nextValue : parseNumeric(getAmountValueFn());
      buttons.forEach(btn=>{
        const v = parseNumeric(btn.getAttribute('data-amount'));
        const on = Number.isFinite(v) && Number.isFinite(active) && Math.abs(v-active)<1e-9;
        btn.classList.toggle('active', on);
      });
    }
    buttons.forEach(btn=>{
      btn.addEventListener('click',(e)=>{
        e.preventDefault();
        const raw = btn.getAttribute('data-amount');
        const parsed = parseNumeric(raw);
        const target = Number.isFinite(parsed) ? parsed.toFixed(2) : raw;
        const amountEl = document.getElementById('amount');
        const hidden   = document.getElementById('n-amount');
        if (amountEl) amountEl.value = target;
        if (hidden && hidden!==amountEl) hidden.value = target;
        if (typeof onValueSelected==='function') onValueSelected();
        if (amountEl){
          amountEl.dispatchEvent(new Event('input',{bubbles:true}));
          amountEl.dispatchEvent(new Event('change',{bubbles:true}));
        }
        updateState(parseNumeric(target));
      });
    });
    updateState();
    const controller={ updateState }; window.__wireQuickAmounts=()=>updateState();
    return controller;
  }

  function initAddFunds(){
    const select = document.getElementById('method'); if (!select) return;

    const optionInfos = Array.from(select.options||[]).map(opt=>{
      const meta = parseJSONSafe(opt.getAttribute('data-meta'));
      const labels = [];
      const baseLabel = opt.textContent || opt.innerText || '';
      if (baseLabel) labels.push(baseLabel);
      if (opt.dataset && opt.dataset.displayLabel) labels.push(opt.dataset.displayLabel);
      const metaLabel = findFirstString(meta,['display_name','displayName','name','title','label']);
      if (metaLabel) labels.push(metaLabel);
      const metaAlias = findFirstString(meta,['alias','short_name','shortName','shortLabel']);
      if (metaAlias) labels.push(metaAlias);
      const tokens = Array.from(new Set(labels.flatMap(tokenize)));
      const slugVariants = Array.from(new Set(labels.map(slugify).filter(Boolean)));
      const primarySlug = slugVariants.slice().sort((a,b)=>b.length-a.length)[0] || slugify(baseLabel);
      return {
        value: opt.value,
        optionEl: opt,
        tokens: tokens.length ? tokens : tokenize(baseLabel),
        slug: primarySlug,
        slugVariants,
        meta,
      };
    });
    const cardInfos = Array.from(document.querySelectorAll('.fund-logo__card')).map(card=>{
      const labels = [];
      const srOnly = card.querySelector('.sr-only')?.textContent;
      if (srOnly) labels.push(srOnly);
      const ariaLabel = card.getAttribute('aria-label');
      if (ariaLabel) labels.push(ariaLabel);
      const dataLabel = card.getAttribute('data-payment-method');
      if (dataLabel) labels.push(dataLabel);
      const textLabel = card.textContent;
      if (textLabel) labels.push(textLabel);
      const tokens = Array.from(new Set(labels.flatMap(tokenize)));
      const slugVariants = Array.from(new Set(labels.map(slugify).filter(Boolean)));
      const primarySlug = slugVariants.slice().sort((a,b)=>b.length-a.length)[0] || slugify(labels[0]||'');
      return {
        el: card,
        tokens: tokens.length ? tokens : tokenize(labels[0]||''),
        slug: primarySlug,
        slugVariants,
      };
    });

    const afterBonusTotalEl = document.querySelector('[data-role="after-bonus-total"]');
    const afterBonusNoteEl  = document.querySelector('[data-role="after-bonus-note"]');
    const amountGroup       = document.getElementById('amount-group');
    const defaultAmountHTML = amountGroup ? amountGroup.innerHTML : '';
    const amountLabelText   = amountGroup?.getAttribute('data-label') || amountGroup?.querySelector('label')?.textContent || '';
    let quickAmountController = null;

    const getAmountInput = ()=>document.getElementById('amount');
    const getHiddenAmountInput = ()=>document.getElementById('n-amount');
    const getAmountValue = ()=>{ const h=getHiddenAmountInput(); if(h&&h.value!==undefined) return h.value; const i=getAmountInput(); return i? i.value : ''; };
    const getAmountNumber = ()=>parseNumeric(getAmountValue());
    const setAmountValue = (v)=>{
      const s = v===undefined||v===null ? '' : String(v);
      const i = getAmountInput();
      if (i){
        if (i.tagName==='SELECT'){
          const m = Array.from(i.options||[]).find(o=>o.value===s);
          if (m) i.value=s; else if (i.options && i.options.length) i.value=i.options[0].value;
        } else { i.value = s; }
      }
      const h=getHiddenAmountInput(); if (h && h!==i) h.value = s;
    };

    function updateAfterBonus(){
      if (!afterBonusTotalEl && !afterBonusNoteEl) return;
      const amtNum = getAmountNumber();
      const selectedInfo = optionInfos.find(info=>info.value===select.value) || null;
      const meta = selectedInfo ? selectedInfo.meta : null;
      const res = computeAfterBonus(meta, amtNum||0);
      if (afterBonusTotalEl) afterBonusTotalEl.textContent = res.formattedTotal;
      if (afterBonusNoteEl){
        if (!Number.isFinite(amtNum) || amtNum<=0){
          const empty = afterBonusNoteEl.getAttribute('data-empty-text');
          afterBonusNoteEl.textContent = empty!==null ? empty : '';
        } else if (res.note){ afterBonusNoteEl.textContent = res.note; }
        else {
          const def = afterBonusNoteEl.getAttribute('data-default-text');
          afterBonusNoteEl.textContent = def!==null ? def : '';
        }
      }
    }
    function attachAmountListeners(){
      const input = getAmountInput(); if (!input) return;
      input.addEventListener('input', ()=>{
        const h=getHiddenAmountInput(); if (h&&h!==input) h.value=input.value;
        updateAfterBonus(); if (quickAmountController) quickAmountController.updateState(parseNumeric(input.value));
      });
      input.addEventListener('change', ()=>{
        updateAfterBonus(); if (quickAmountController) quickAmountController.updateState(parseNumeric(input.value));
      });
    }
    function renderAmountFieldForPayment(paymentId){
      const match = optionInfos.find(info=>info.value===paymentId); if (!match) return;
      const meta  = match.meta || {};
      const wrap  = document.getElementById('amount-group'); if (!wrap) return;

      const requiresSelect = Boolean(findFirstString(meta,['amount_select','select_amount']));
      const amountOptions  = Array.isArray(meta?.amount_options) ? meta.amount_options : null;
      const minAmount      = findFirstNumber(meta,['min','minimum','min_amount','minimum_amount']);
      const maxAmount      = findFirstNumber(meta,['max','maximum','max_amount','maximum_amount']);
      const placeholder    = findFirstString(meta,['placeholder','amount_placeholder']) || '0.00';

      if (requiresSelect && amountOptions && amountOptions.length){
        const s = document.createElement('select');
        s.className='form-control'; s.id='amount'; s.name='AddFoundsForm[amount]';
        amountOptions.forEach(opt=>{
          const v = parseNumeric(opt?.value ?? opt); if(!Number.isFinite(v)) return;
          const o=document.createElement('option'); o.value=v.toFixed(2); o.textContent=opt?.label || v.toFixed(2); s.appendChild(o);
        });
        wrap.innerHTML='';
        const lab=document.createElement('label'); lab.className='control-label'; lab.htmlFor='amount'; lab.textContent=amountLabelText;
        wrap.appendChild(lab); wrap.appendChild(s);
        s.addEventListener('change', ()=>{
          setAmountValue(s.value); updateAfterBonus();
          if (quickAmountController) quickAmountController.updateState(parseNumeric(s.value));
        });
        setAmountValue(s.value);
      } else {
        wrap.innerHTML = defaultAmountHTML;
        const input = wrap.querySelector('input');
        if (input){
          input.placeholder = placeholder;
          if (Number.isFinite(minAmount)) input.min = minAmount;
          if (Number.isFinite(maxAmount)) input.max = maxAmount;
          input.addEventListener('input', ()=>{
            const h=document.getElementById('n-amount'); if (h&&h!==input) h.value=input.value;
            updateAfterBonus(); if (quickAmountController) quickAmountController.updateState(parseNumeric(input.value));
          });
          input.addEventListener('change', ()=>{
            updateAfterBonus(); if (quickAmountController) quickAmountController.updateState(parseNumeric(input.value));
          });
        }
        setAmountValue(getAmountValue());
      }
      attachAmountListeners();
      if (quickAmountController) quickAmountController.updateState(parseNumeric(getAmountValue()));
      updateAfterBonus();
    }
    function updateActiveLogo(){
      const selected = optionInfos.find(i=>i.value===select.value);
      const cards = cardInfos;
      if (!selected){
        cards.forEach(info=>{ info.el.classList.remove('active'); info.el.setAttribute('aria-pressed','false'); });
        return;
      }
      const active = getMatchedInfoByTokens(cards, selected.tokens, selected.slugVariants || selected.slug);
      cards.forEach(info=>{
        const on = active && active.el===info.el;
        info.el.classList.toggle('active', on);
        info.el.setAttribute('aria-pressed', on ? 'true':'false');
      });
    }
    cardInfos.forEach(info=>{
      info.el.addEventListener('click', ()=>{
        const match = getMatchedInfoByTokens(optionInfos, info.tokens, info.slugVariants || info.slug);
        if (!match) return;
        select.value = match.value;
        select.dispatchEvent(new Event('change',{bubbles:true}));
        if (window.jQuery){ try{ window.jQuery(select).trigger('change'); }catch(e){} }
      });
    });
    select.addEventListener('change', ()=>{
      renderAmountFieldForPayment(select.value);
      updateActiveLogo();
    });

    if (String(select.value) === '168114'){ renderAmountFieldForPayment(select.value); }
    else { attachAmountListeners(); const getVal=()=>getAmountValue(); const cb=()=>updateAfterBonus(); const qc = wireQuickAmounts(cb, getVal); quickAmountController = qc; updateAfterBonus(); }
    updateActiveLogo();
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    bindMethodDropdown();
    initAddFunds();
    
    // Main Tabs Switching (Add Funds / Payment History)
    const mainTabs = document.querySelectorAll('.tabs a.tab[data-tab]');
    const mainTabContents = document.querySelectorAll('[data-tab-content]');
    
    mainTabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const targetTab = tab.getAttribute('data-tab');
        
        // Remove active class from all tabs
        mainTabs.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
          t.classList.remove('bg-gradient-to-r', 'from-primary-500', 'to-primary-600', 'text-white', 'shadow-md');
          t.classList.add('text-gray-600', 'dark:text-gray-400');
          if (t !== tab) {
            t.classList.remove('hover:bg-gray-100', 'dark:hover:bg-dark-tertiary');
          }
        });
        
        // Add active class to clicked tab
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
        tab.classList.remove('text-gray-600', 'dark:text-gray-400', 'hover:bg-gray-100', 'dark:hover:bg-dark-tertiary');
        tab.classList.add('bg-gradient-to-r', 'from-primary-500', 'to-primary-600', 'text-white', 'shadow-md');
        
        // Hide all tab contents
        mainTabContents.forEach(content => {
          content.classList.add('hidden');
          content.classList.remove('active');
        });
        
        // Show selected tab content
        const selectedContent = document.querySelector(`[data-tab-content="${targetTab}"]`);
        if (selectedContent) {
          selectedContent.classList.remove('hidden');
          selectedContent.classList.add('active');
        }
      });
    });
    
    // Payment Methods Tabs (Right Sidebar)
    const paymentMethodTabs = document.querySelectorAll('.payment-methods .payment-method-tab');
    const paymentMethodContents = document.querySelectorAll('.info-block > [data-tab-content]');
    
    function switchPaymentMethodTab(targetTab) {
      // Remove active class from all payment method tabs
      paymentMethodTabs.forEach(t => {
        t.classList.remove('active');
        t.classList.remove('border-primary-500', 'border-2', 'bg-gradient-to-r', 'from-primary-500', 'to-primary-600', 'text-white', 'shadow-md');
        t.classList.add('border-gray-300', 'dark:border-dark-tertiary', 'bg-white', 'dark:bg-dark-card', 'text-gray-700', 'dark:text-gray-300');
      });
      
      // Add active class to clicked tab
      const clickedTab = Array.from(paymentMethodTabs).find(t => t.getAttribute('data-tab') === targetTab);
      if (clickedTab) {
        clickedTab.classList.add('active', 'border-primary-500', 'border-2', 'bg-gradient-to-r', 'from-primary-500', 'to-primary-600', 'text-white', 'shadow-md');
        clickedTab.classList.remove('border-gray-300', 'dark:border-dark-tertiary', 'bg-white', 'dark:bg-dark-card', 'text-gray-700', 'dark:text-gray-300');
      }
      
      // Hide all payment method contents
      paymentMethodContents.forEach(content => {
        content.classList.add('hidden');
        content.classList.remove('active');
        content.style.display = 'none';
      });
      
      // Show selected payment method content
      const selectedContent = document.querySelector(`.info-block > [data-tab-content="${targetTab}"]`);
      if (selectedContent) {
        selectedContent.classList.remove('hidden');
        selectedContent.classList.add('active');
        selectedContent.style.display = 'block';
        console.log('Showing content for:', targetTab, selectedContent);
      } else {
        console.log('Content not found for:', targetTab);
      }
    }
    
    paymentMethodTabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        const targetTab = tab.getAttribute('data-tab');
        console.log('Payment method tab clicked:', targetTab);
        switchPaymentMethodTab(targetTab);
      });
    });
    
    // Initialize first tab as active
    if (paymentMethodTabs.length > 0) {
      const firstTab = paymentMethodTabs[0];
      const firstTabName = firstTab.getAttribute('data-tab');
      switchPaymentMethodTab(firstTabName);
    }
  });
})();
</script>



